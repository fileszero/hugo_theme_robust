{{ $page := .}}
{{ $url := ""}}
{{ $img := $page.Resources.GetMatch (printf "**%s" .Params.featured_image) }}
{{ if $img }}
    {{ $url = $img.Permalink}}
{{else}}
  {{ $first_img := findRE "<img.*?src=[^>]*?>" .Content 1 }}
  {{ if $first_img }}
    {{ range $first_img }}
      {{ $src := (. | findRE "data-original=[\"'][^\"']+") }}
      {{ if not $src }}
        {{ $src = (. | findRE "src=[\"'][^\"']+") }}
      {{ end }}
      {{ range $src }}
        {{ $url = (replaceRE "(data-original|src)=[\"']" "" . )}}
        {{ $img := $page.Resources.GetMatch (printf "**%s" $url) }}
        {{ if $img }}
            {{ $url = $img.Permalink}}
        {{end}}
      {{end}}
    {{end}}
  {{ end }}
{{ end }}

{{ if eq $url ""}}
  <div class="thumb"></div>
{{else}}
  <div class="thumb " style="background-image:url({{ $url }})"></div>
{{end}}