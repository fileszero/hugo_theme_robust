{{ $page := .}}
{{ $image_url := ""}}
{{ if hasPrefix .Params.featured_image "/" }}
  {{ $image_url = .Params.featured_image}}
{{ end }}
{{if eq $image_url ""}}
  {{ $img := $page.Resources.GetMatch (printf "**%s" .Params.featured_image) }}
  {{ if $img }}
      {{ $image_url = $img.Permalink}}
  {{else}}
    {{ $first_img := findRE "<img.*?src=[^>]*?>" .Content 1 }}
    {{ if $first_img }}
      {{ range $first_img }}
        {{ $src := (. | findRE "data-original=[\"'][^\"']+") }}
        {{ if not $src }}
          {{ $src = (. | findRE "src=[\"'][^\"']+") }}
        {{ end }}
        {{ range $src }}
          {{ $image_url = (replaceRE "(data-original|src)=[\"']" "" . )}}
          {{ $img := $page.Resources.GetMatch (printf "**%s" $image_url) }}
          {{ if $img }}
              {{ $image_url = $img.Permalink}}
          {{end}}
        {{end}}
      {{end}}
    {{ end }}
  {{ end }}
{{ end }}

{{ if eq $image_url ""}}
  <div class="thumb"></div>
{{else}}
  <div class="thumb " style="background-image:url({{ $image_url }})"></div>
{{end}}

